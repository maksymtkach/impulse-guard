(()=>{var a={HIGH_RISK:70,COOLDOWN:5,BADGE:26,GAP:6,PANEL_W:420,PANEL_MARGIN:8};"COOLDOWN"in a||(a.COOLDOWN=5);var m={API_URL:"http://127.0.0.1:8000",API_TOKEN:""};function $(){return new Promise(t=>{try{chrome.storage.sync.get(["API_URL","API_TOKEN"],e=>{e.API_URL&&(m.API_URL=e.API_URL),e.API_TOKEN&&(m.API_TOKEN=e.API_TOKEN),t(m)})}catch{t(m)}})}var n={lastOriginalText:"",editor:null,panelOpen:!1,last:{risk:0,hits:[],emotions:{}},debounce:null,cooling:!1,cooldownEnd:0,readyToSend:!1,bypassSend:!1,cooldownTimerId:null};function O(t){let e=(t||"").toLowerCase(),o=[],r=(c,v,R,S,Y=[],Q=null)=>{let B;for(;B=c.exec(e);)o.push({i:B.index,l:B[0].length,label:v,sev:R,why:S,sugg:Y,emo:Q})};r(/\b(idiot|stupid|useless|dumb|moron)\b/g,"insult",40,"Insults escalate quickly.",["Remove judgement"],"anger"),r(/\b(never|always)\b/g,"absolutism",12,"Absolutes are unfair.",["often","sometimes"],"frustration"),r(/\byou\b[^.!?\n]{0,12}\b(suck|lie|fail|ruined)\b/g,"you-attack",25,"Personal attack.",["Describe the fact, not the person"],"anger"),r(/\b(last chance|or else)\b/gi,"ultimatum",20,"Ultimatum triggers defensiveness.",["Propose a deadline"],"urgency"),r(/\b(i don't care|whatever)\b/gi,"dismissive",15,"Dismissive breaks trust.",["I want to resolve this"],"contempt"),r(/\b(sure\.\.\.|yeah right)\b/g,"sarcasm",10,"Sarcasm reads as contempt.",["State it plainly"],"sarcasm");let l=(e.match(/\b(maybe|might|i feel|i think|perhaps)\b/g)||[]).length,d={insult:40,"you-attack":25,ultimatum:20,dismissive:15,absolutism:12,sarcasm:10},i={};o.forEach(c=>i[c.label]=(i[c.label]||0)+c.sev);let s=0;Object.keys(i).forEach(c=>s+=Math.min(i[c],d[c]||i[c])),s-=Math.min(l*3,12);let f={anger:0,frustration:0,sarcasm:0,contempt:0,urgency:0};return o.forEach(c=>{c.emo&&(f[c.emo]=Math.min(100,f[c.emo]+c.sev*4))}),{risk:Math.max(0,Math.min(100,Math.round(s))),hits:o,emotions:f}}function _(t){if(!t)return"";let e=String(t);return e=e.replace(/^\s*(\d+[\).\-\s]+)?\s*/i,""),e=e.replace(/^(direct(?:\s*&?|\s+and)?\s*neutral|empathetic|firm\s+boundaries)\s*:\s*/i,""),e=e.replace(/\bi don'?t care\b/gi,"I want to resolve this"),e=e.replace(/\bwhatever\b/gi,"I want to resolve this"),e=e.replace(/\s*\.\.\.+/g,"\u2026"),e=e.replace(/([.!?])\1+/g,"$1"),e=e.replace(/\s{2,}/g," ").trim(),/[.!?â€¦]$/.test(e)||(e+="."),e}function G(t){let e={};return t.forEach(o=>{e[o.label]=(e[o.label]||0)+1}),e}function y(t){let e=t;for(;e&&e!==document.body;){if(e.tagName==="TEXTAREA")return e;let o=e.isContentEditable||e.getAttribute?.("contenteditable")==="true",r=e.getAttribute?.("role")==="textbox";if(o||r)return e;e=e.parentElement}return t}function w(t){let e=y(t);return"value"in e?e.value:e.innerText??e.textContent??""}function I(t,e){let o=y(t);if(o.focus(),"value"in o)return o.value=e,o.dispatchEvent(new Event("input",{bubbles:!0})),o.dispatchEvent(new Event("change",{bubbles:!0})),!0;try{let r=o.ownerDocument,l=r.getSelection(),d=r.createRange();if(d.selectNodeContents(o),l.removeAllRanges(),l.addRange(d),r.execCommand("insertText",!1,e))return o.dispatchEvent(new InputEvent("input",{bubbles:!0,inputType:"insertFromPaste",data:e})),!0}catch{}try{return o.textContent=e,o.dispatchEvent(new InputEvent("input",{bubbles:!0,inputType:"insertFromPaste",data:e})),!0}catch{}return!1}var Z=new Set(["relative","absolute","fixed","sticky"]),g=null,u=null,x=null,A=null,L=null;function D(t){let e=t;for(;e&&e!==document.body;){let o=getComputedStyle(e);if(Z.has(o.position))return e;e=e.parentElement}return document.body}function ee(){u&&x||(u=document.createElement("div"),u.style.position="absolute",u.style.zIndex="2147483647",u.style.pointerEvents="none",x=u.attachShadow({mode:"open"}),x.innerHTML=`
    <style>
      .wrap{ pointer-events:auto; font:12px system-ui,sans-serif; }
      .badge{ width:${a.BADGE}px; height:${a.BADGE}px; position:absolute; right:0; bottom:0;
              transform: translate(-${a.GAP}px, -${a.GAP}px);
              border-radius:999px; background:#111; color:#fff; display:grid; place-items:center;
              cursor:pointer; box-shadow:0 8px 24px rgba(0,0,0,.35) }
      .num{ position:absolute; font-size:10px; font-weight:800 }
      svg{ transform:rotate(-90deg) }
    </style>
    <div class="wrap">
      <div class="badge" id="igBadge" title="Sentiscore">
        <svg width="${a.BADGE}" height="${a.BADGE}">
          <circle cx="${a.BADGE/2}" cy="${a.BADGE/2}" r="${a.BADGE/2-3}" stroke="#333" stroke-width="3" fill="none"></circle>
          <circle id="ring" cx="${a.BADGE/2}" cy="${a.BADGE/2}" r="${a.BADGE/2-3}" stroke="#22c55e" stroke-width="3" fill="none" stroke-linecap="round"></circle>
        </svg>
        <div class="num" id="num">0</div>
      </div>
    </div>
  `,x.getElementById("igBadge").addEventListener("click",t=>{t.stopPropagation(),window.__IG_togglePanel?.(!0)}))}function H(t){if(g===t&&u?.parentElement===g)return;if(te(),g=t,ee(),g.appendChild(u),A)try{A.disconnect()}catch{}A=new ResizeObserver(()=>h());try{A.observe(g),n.editor&&A.observe(n.editor)}catch{}if(L)try{L.disconnect()}catch{}L=new MutationObserver(()=>h()),L.observe(g,{attributes:!0,subtree:!0,childList:!0});let e=g;for(;e&&e!==document.body;)e.addEventListener("scroll",h,!0),e=e.parentElement;window.addEventListener("scroll",h,!0),window.addEventListener("resize",h,!0),h()}function h(){if(!u||!g)return;let t=g.getBoundingClientRect();u.style.left=g.scrollLeft+0+"px",u.style.top=g.scrollTop+0+"px",u.style.width=t.width+"px",u.style.height=t.height+"px"}function te(){u?.parentElement&&u.parentElement.removeChild(u),u=null,x=null}function M(t){if(!x)return;let e=x.getElementById("ring"),o=x.getElementById("num"),r=a.BADGE/2-3,l=2*Math.PI*r,d=Math.max(0,Math.min(100,t));e.setAttribute("stroke-dasharray",String(l)),e.setAttribute("stroke-dashoffset",String(l*(1-d/100))),e.setAttribute("stroke",t<40?"#22c55e":t<70?"#f59e0b":"#ef4444"),o.textContent=String(t)}var b=null,p=null;function T(){b&&p||(b=document.createElement("div"),b.style.position="fixed",b.style.zIndex="2147483647",b.style.left="0",b.style.top="0",b.style.width="0",b.style.height="0",p=b.attachShadow({mode:"open"}),p.innerHTML=`
  <style>
    .panel{
      position: fixed; left: 0; top: 0;
      background:#fff; color:#111;
      border-radius:12px; padding:12px;
      width:${a.PANEL_W}px; max-width:min(${a.PANEL_W}px,92vw);
      max-height:60vh; overflow:auto;
      box-shadow:0 20px 50px rgba(0,0,0,.25);
      display:none; font:13px system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      z-index:2;
    }
    .issue{ border:1px solid #eef2f7; border-radius:10px; padding:8px 10px; margin:8px 0; background:#fafbff; }
    .issue:hover{ background:#f5f7ff; }
    .bar>div{ transition:width .25s ease; }
    .disclaimer{ color:#9aa3af; font-size:11px; }
    .title{ font-weight:700; margin:6px 0 2px }
    .emo{ display:flex; gap:8px; align-items:center; margin:4px 0 }
    .bar{ height:6px; flex:1; background:#eee; border-radius:6px; overflow:hidden }
    .why{ color:#6b7280; font-size:12px }
    .chip{ display:inline-block; margin:4px 6px 0 0; padding:2px 8px; border-radius:999px; border:1px solid #e5e7eb; background:#f8fafc; cursor:pointer }
    .btn{ background:#111; color:#fff; border:none; border-radius:8px; padding:6px 10px; cursor:pointer; font-weight:700 }
    .cool{
      position: fixed; left:0; top:0;
      background:#111; color:#fff;
      padding:10px; border-radius:12px;
      font-weight:700; display:none;
      box-shadow:0 12px 32px rgba(0,0,0,.28);
      max-width:min(480px, 92vw);
      z-index:2147483647;
    }
    .cool .row{ display:flex; gap:6px; flex-wrap:wrap; margin-top:6px }
    .cool button{
      background:#fff; color:#111; border:none; border-radius:8px;
      padding:6px 10px; font-weight:700; cursor:pointer
    }
  </style>
  <div class="panel" id="panel"></div>
  <div class="cool" id="cool"></div>
`,document.documentElement.appendChild(b),document.addEventListener("click",t=>{n.panelOpen&&(p.contains(t.target)||E(!1))},!0),document.addEventListener("keydown",t=>{t.key==="Escape"&&E(!1)},!0))}function E(t){T();let e=p.getElementById("panel");t?(ne(),e.style.visibility="hidden",e.style.display="block",K(),e.style.visibility="visible"):e.style.display="none",n.panelOpen=t}function K(){if(!n.editor)return;let t=p.getElementById("panel"),e=n.editor.getBoundingClientRect(),o=Math.min(a.PANEL_W,Math.floor(window.innerWidth*.92)),r=t.offsetHeight||260,l=10,d=e.right-o,i=e.top-r-l;i<a.PANEL_MARGIN&&(i=e.bottom+l),d=Math.max(a.PANEL_MARGIN,Math.min(window.innerWidth-o-a.PANEL_MARGIN,d));let s=i+r+a.PANEL_MARGIN-window.innerHeight;s>0&&(i=Math.max(a.PANEL_MARGIN,i-s)),t.style.left=Math.round(d)+"px",t.style.top=Math.round(i)+"px"}function ne(){let t=p.getElementById("panel"),e=w(n.editor),{hits:o,emotions:r}=n.last,l=(s,f)=>`<div class="emo"><div style="width:90px">${s}</div><div class="bar"><div style="width:${f}%"></div></div><div style="width:32px;text-align:right">${f}</div></div>`,d=l("Anger",r.anger||0)+l("Frustration",r.frustration||0)+l("Sarcasm",r.sarcasm||0)+l("Contempt",r.contempt||0)+l("Pressure",r.urgency||0),i=o.slice(0,8).map((s,f)=>{let k=e.slice(s.i,s.i+s.l),c={insult:"Insult",absolutism:"Absolutism","you-attack":"Personal attack",ultimatum:"Ultimatum",dismissive:"Dismissive",sarcasm:"Sarcasm"},v=s.sev>=15?"super-risky":"warning",R=(s.sugg||[]).map(S=>`<span class="chip" data-from="${encodeURIComponent(k)}" data-to="${encodeURIComponent(S)}">${S}</span>`).join("");return`<div class="issue"><b>${f+1}. ${c[s.label]||s.label} <span style="color:${s.sev>=15?"#ef4444":"#f59e0b"}">(${v})</span>:</b>
      <span style="text-decoration: underline wavy ${s.sev>=15?"red":"orange"}">${k}</span>
      <div class="why">${s.why}</div>
      <div>${R}</div>
    </div>`}).join("")||'<div class="issue">No risky phrases detected. Nice!</div>';t.innerHTML=`
    <div class="title">Emotions</div>${d}
    <div class="title">Risk highlights</div>${i}
    <div style="margin-top:8px"><button class="btn" id="igRewrite">Rewrite</button></div>
    <div class="disclaimer">ImpulseGuard prevents sending high-risk messages (5s cooldown).</div>
  `,t.querySelectorAll(".chip").forEach(s=>{s.addEventListener("click",()=>{let f=decodeURIComponent(s.getAttribute("data-from")),k=decodeURIComponent(s.getAttribute("data-to")),c=w(n.editor),v=c.toLowerCase().indexOf(f.toLowerCase());v>=0&&I(n.editor,c.slice(0,v)+k+c.slice(v+f.length)),E(!1)})}),t.querySelector("#igRewrite").addEventListener("click",oe)}async function oe(){let t=p.getElementById("panel"),e=w(n.editor);n.lastOriginalText=e,t.innerHTML='<div class="title">Rewriting\u2026</div>';let o=[];try{let i=await fetch(`${m.API_URL}/rewrite`,{method:"POST",headers:{"Content-Type":"application/json",...m.API_TOKEN?{Authorization:"Bearer "+m.API_TOKEN}:{}},body:JSON.stringify({text:e})});if(i.ok){let s=await i.json();o=Array.isArray(s.variants)?s.variants.filter(Boolean):[]}}catch{}if(!o.length){let i=s=>s.replace(/\bnever\b/gi,"often").replace(/\balways\b/gi,"usually").replace(/\bi don'?t care\b/gi,"I want to resolve this").replace(/\bwhatever\b/gi,"I want to resolve this").replace(/\byou (suck|lie|fail|ruined)\b/gi,"this didn\u2019t meet expectations");o=[`Direct and neutral: ${i(e)}. Let's agree on next steps and a clear timeline.`,`Empathetic: I feel concerned. I'd like to focus on facts and fix it together: ${i(e)}`,"Firm boundaries: Please avoid judgments. Here's how we proceed: 1) \u2026 2) \u2026 3) \u2026"]}let r=o.map(_).filter(i=>i.length>0),l=r[0]||e;I(n.editor,l),z(()=>{I(n.editor,n.lastOriginalText)});let d=r.slice(1,3).map((i,s)=>`<div class="issue alt" data-v="${encodeURIComponent(i)}">Alternative ${s+2}: ${i}</div>`).join("");t.innerHTML=`
    <div class="issue"><b>Rewritten.</b> Applied a neutral version. You can switch alternatives or Undo.</div>
    ${d||'<div class="why">No more alternatives.</div>'}
  `,t.querySelectorAll(".alt").forEach(i=>{i.addEventListener("click",()=>{let s=decodeURIComponent(i.getAttribute("data-v"));I(n.editor,s),z(()=>{I(n.editor,n.lastOriginalText)}),E(!1)})})}function U(){return T(),p}function P(){try{K()}catch{}}function z(t){T();let e=p.getElementById("snack");if(!e){let o=document.createElement("style");o.textContent=`
      .snack{ position: fixed; right:16px; bottom:16px; background:#111; color:#fff;
              border-radius:10px; padding:10px 12px; font-weight:700;
              box-shadow:0 12px 32px rgba(0,0,0,.28); display:flex; align-items:center; gap:8px; z-index:2147483647 }
      .snack button{ background:#fff; color:#111; border:none; border-radius:8px; padding:4px 8px; font-weight:700; cursor:pointer }
    `,p.appendChild(o),e=document.createElement("div"),e.id="snack",e.className="snack",e.style.display="none",e.innerHTML='<span>Rewritten</span><button id="snackUndo">Undo</button>',p.appendChild(e)}e.style.display="flex",e.querySelector("#snackUndo").onclick=()=>{e.style.display="none",t&&t()},setTimeout(()=>{e.style.display="none"},7e3)}function C(t){let e=n.editor.getBoundingClientRect(),o=10,r=t.offsetWidth||260,l=t.offsetHeight||54,d=e.left+(e.width-r)/2,i=e.top-l-o;i<o&&(i=e.bottom+o),d=Math.max(o,Math.min(window.innerWidth-r-o,d)),i=Math.max(o,Math.min(window.innerHeight-l-o,i)),t.style.left=Math.round(d)+"px",t.style.top=Math.round(i)+"px"}function W(t=!0){n.cooldownTimerId&&(clearInterval(n.cooldownTimerId),n.cooldownTimerId=null);let e=p?.getElementById("cool");e&&(e.style.display="none",e.innerHTML=""),n.cooling=!1,t&&(n.readyToSend=!1)}function N(t){return t&&(t.tagName==="TEXTAREA"||t.isContentEditable||t.getAttribute?.("contenteditable")==="true"||t.getAttribute?.("role")==="textbox")}function j(t){n.editor=y(t);let e=D(n.editor.parentElement||n.editor);H(e);let o=w(n.editor);n.last=O(o),M(n.last.risk),h()}function ie(){if(m.API_TOKEN)try{fetch(`${m.API_URL}/event`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+m.API_TOKEN},body:JSON.stringify({score:n.last.risk,emotions:n.last.emotions,risks:G(n.last.hits)})})}catch{}}function q(){return[...document.querySelectorAll('button,div[role="button"]')].find(t=>/send/i.test(t.getAttribute("aria-label")||"")||/tgico-send/.test(t.className||""))}function J(){return document.querySelector('div[role="button"][data-tooltip*="Send"], div[role="button"][aria-label^="Send"]')}function V(){n.bypassSend=!0;let t=location.host.includes("web.telegram.org"),e=location.host.includes("mail.google.com"),o=t?q():e?J():null;o?o.click():n.editor&&(n.editor.dispatchEvent(new KeyboardEvent("keydown",{key:"Enter",bubbles:!0})),n.editor.dispatchEvent(new KeyboardEvent("keyup",{key:"Enter",bubbles:!0}))),setTimeout(()=>{n.bypassSend=!1},60)}function F(){if(n.cooling&&Date.now()<n.cooldownEnd)return;n.cooling=!0,n.readyToSend=!1,n.cooldownEnd=Date.now()+a.COOLDOWN*1e3,T();let t=U(),e=t.getElementById("cool");e.style.display="block",e.textContent="...",C(e),n.cooldownTimerId&&clearInterval(n.cooldownTimerId),n.cooldownTimerId=setInterval(o,250),o();function o(){let r=Math.max(0,n.cooldownEnd-Date.now()),l=Math.ceil(r/1e3);r>0?(e.textContent=`High risk. Cooling down: ${l}s\u2026`,C(e)):(clearInterval(n.cooldownTimerId),n.cooldownTimerId=null,n.cooling=!1,n.readyToSend=!0,e.innerHTML=`
        <div style="margin-bottom:6px">High risk paused</div>
        <div class="row">
          <button id="igSendAnyway">Send anyway</button>
          <button id="igRewrite2">Rewrite</button>
          <button id="igCancelHold">Cancel</button>
        </div>
        <div style="margin-top:6px;color:#bbb;font-size:11px">Or press Enter again to send.</div>
      `,C(e),t.getElementById("igSendAnyway")?.addEventListener("click",()=>{n.readyToSend=!1,e.style.display="none",V()}),t.getElementById("igRewrite2")?.addEventListener("click",()=>{E(!0),e.style.display="none"}),t.getElementById("igCancelHold")?.addEventListener("click",()=>{n.readyToSend=!1,e.style.display="none"}))}}function X(){window.__IG_togglePanel=E,document.addEventListener("focusin",t=>{N(t.target)&&j(t.target)},!0),document.addEventListener("input",t=>{N(t.target)&&(t.target!==n.editor&&j(t.target),clearTimeout(n.debounce),n.debounce=setTimeout(()=>{let e=w(n.editor);n.last=O(e),M(n.last.risk),h(),n.panelOpen&&P()},100))},!0),document.addEventListener("selectionchange",()=>{if(!n.panelOpen||!n.editor)return;let t=document.getSelection();if(!t||t.rangeCount===0)return;let e=t.anchorNode;e&&y(e.nodeType===3?e.parentElement:e)===y(n.editor)&&P()},!0),window.addEventListener("scroll",()=>{n.panelOpen&&P()},!0),window.addEventListener("resize",()=>{n.panelOpen&&P()},!0),["keydown","keypress","keyup"].forEach(t=>{document.addEventListener(t,e=>{if(!n.editor||!N(n.editor))return;let o=y(e.target?.nodeType===3?e.target.parentElement:e.target);if(o&&o!==y(n.editor))return;let r=location.host.includes("web.telegram.org"),d=location.host.includes("mail.google.com")&&e.key==="Enter"&&(e.ctrlKey||e.metaKey||!e.shiftKey),i=r&&e.key==="Enter"&&!e.shiftKey;e.type.startsWith("key")&&(d||i)&&(n.bypassSend||n.last.risk>=a.HIGH_RISK&&(n.readyToSend?(n.readyToSend=!1,e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation?.(),V()):(e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation?.(),F())))},!0)}),document.addEventListener("click",t=>{let e=t.target;if((e&&(e===q()||e===J())||e?.closest&&(e.closest('[aria-label="Send"]')||e.closest(".tgico-send")))&&!n.bypassSend&&n.last.risk>=a.HIGH_RISK)if(n.readyToSend){n.readyToSend=!1,W(!1),setTimeout(()=>ie(),0);return}else t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation?.(),F()},!0)}(async function(){await $(),X()})();})();
